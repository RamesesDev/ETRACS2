<workunit>
    <invokers>
        <invoker type="report:consolidatedreport" action="init" caption="Consolidated AF Report" target="popup" />
        
        <invoker type="formActions" action="view" caption="View" mnemonic="v" shortcut="ctrl v" visibleWhen="#{mode == 'build'}" />
        <invoker type="formActions" action="back" caption="Back" mnemonic="b" shortcut="ctrl b" visibleWhen="#{mode == 'view'}" />
    </invokers>
    <code>
<![CDATA[

import com.rameses.rcp.common.*;
import com.rameses.rcp.annotations.*;
import com.rameses.osiris2.client.*;
import com.rameses.osiris2.reports.*;

class CRAAFController extends etracs2.groovy.ReportController
{
    
    @Service("ConsolidatedReportService")
    def svc;
    
    @Service("Var")
    def var;
    
    @Service("DateService")
    def dateSvc;
    
    def getVarService() { return var; }
    def getDateService() { return dateSvc; }
    def getService() { return svc; }
    def months;
    
    void init(){
       def cal = Calendar.getInstance(); 
       entity = [
            year : dateSvc.getServerDate(),
            day  : cal.get(Calendar.DATE)
       ];
    }
    
    void setMonths( months ){
        entity.month = months.value;
        entity.monthname = months.name;
    }
    
    def view() {
       data = svc.buildReport( entity );
       if( !data ) throw new Exception("No results found.");
       data += [
            craafyear   : entity.year,
            craafmonth  : entity.monthname,
            craafday    : entity.day
       ];
       report.viewReport();
       mode = 'view';
       return "preview";
    }
    
    def getMonthList(){
        return [
            [name:"JANUARY", value:1],
            [name:"FEBRUARY", value:2],
            [name:"MARCH", value:3],
            [name:"APRIL", value:4],
            [name:"MAY", value:5],
            [name:"JUNE", value:6],
            [name:"JULY", value:7],
            [name:"AUGUST", value:8],
            [name:"SEPTEMBER", value:9],
            [name:"OCTOBER", value:10],
            [name:"NOVEMBER", value:11],
            [name:"DECEMBER", value:12]
        ];
    }
    
    public String reportName(){
        return "etracs2/tc/report/ConsolidatedReport.jasper";
    }
    
    def getStandardReportParams() {
        return super.standardReportParams + [
            MONTH       : entity.monthname,
            YEAR        : Integer.parseInt( entity.year )
        ]; 
    }
}

]]>        
        
    </code>
    <pages>
        <page name="reportPage" template="etracs2.tc.report.CRAAFPage"/>
        <page name="preview" template="etracs2.tc.PreviewPage" />
    </pages>
</workunit>