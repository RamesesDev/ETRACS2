import com.rameses.annotations.*;
import com.rameses.common.*;
import java.rmi.server.UID;
import java.text.DecimalFormat;

class RemittanceReportService {

	@PersistenceContext("main")
	def em;
	
	@Service("DateService")
	def dtsvc;
	
	@ProxyMethod
	public def generateRCD( rem ) {
		
		def data = [
			collectorName 		: rem.info.collectorname,
			collectorTitle		: rem.info.collectortitle,
			docno 				: rem.info.txnno,
			dateposted			: dtsvc.parse( "yyyy-MM-dd", rem.info.txndate ),
			totalDenomination	: rem.info.totalcash,
			totalchecks			: rem.info.totalotherpayments,
			amount				: rem.info.amount,
			liquidatingOfficerName	: rem.liquidatingofficername,
			liquidatingOfficerTitle	: rem.liquidatingofficertitle,
			remittedforms			: getSerialRemittedFormsByRemittance( rem.objid ),
			nonserialremittances 	: getNonSerialRemittedFormsByRemittance( rem.objid ),
			otherpayments		: rem.otherpayments,
			denominations		: rem.info.denominations
		]
		
		return data;
		
	}
	
	private def getSerialRemittedFormsByRemittance( remid ) {
		return em.sqlContext.createNamedQuery( "remittance:getSerialRemittedFormsByRemittance" ).setParameters( [remittanceid:remid] ).resultList;
	}
	
	private def getNonSerialRemittedFormsByRemittance( remid ) {
		return em.sqlContext.createNamedQuery( "remittance:getNonSerialRemittedFormsByRemittance" ).setParameters( [remittanceid:remid] ).resultList;
	}
	
	
	
	@ProxyMethod
	public def generateReportByCollectionType( rem, collectiontype ) {
		rem.info.txndate = dtsvc.parse( "yyyy-MM-dd", rem.info.txndate );
		rem.receipts = getReceiptsByRemittanceCollectionType( rem, collectiontype );
		return rem;
	}
	
	private def getReceiptsByRemittanceCollectionType( rem, collectiontype ) {
		def qry = em.sqlContext.createNamedQuery( "remittance:getReceiptsByRemittanceCollectionType" );
		if ( collectiontype )
			qry.setParameter( "collectiontypeid", collectiontype.objid )
		return qry.setParameter( "remittanceid", rem.objid ).resultList;
	}
	
	
	
	@ProxyMethod
	public def generateReportByFund( rem, fund ) {
		rem.info.txndate = dtsvc.parse( "yyyy-MM-dd", rem.info.txndate );
		rem.receipts = getReceiptDetailsByFund( rem, fund );
		rem.acctsummaries = getIncomeAccuntSummaryByFund( rem, fund );
		return rem;
	}
	
	private def getReceiptDetailsByFund( rem, fund ) {
		def qry = em.sqlContext.createNamedQuery( "remittance:getReceiptDetailsByFund" );
		if ( fund )
			qry.setParameter( "fundid", fund.objid );
		return qry.setParameter( "remittanceid", rem.objid ).resultList;
	}
	
	private def getIncomeAccuntSummaryByFund( rem, fund ) {
		def qry = em.sqlContext.createNamedQuery( "remittance:getIncomeAccuntSummaryByFund" );
		if ( fund )
			qry.setParameter( "fundid", fund.objid );
		return qry.setParameter( "remittanceid", rem.objid ).resultList;
	}
	
	
	
	@ProxyMethod
	public def generateReportByFundDetailed( rem, fund ) {
		rem.info.txndate = dtsvc.parse( "yyyy-MM-dd", rem.info.txndate );
		rem.serials = getSerialReceiptDetailsByFund( rem, fund );
		rem.nonserial = getNonSerialReceiptDetailsByFund( rem, fund );
		return rem;
	}
	
	private def getSerialReceiptDetailsByFund( rem, fund ) {
		def qry = em.sqlContext.createNamedQuery( "remittance:getSerialReceiptDetailsByFund" );
		if ( fund )
			qry.setParameter( "fundid", fund.objid );
		return qry.setParameter( "remittanceid", rem.objid ).resultList;
	}
	
	private def getNonSerialReceiptDetailsByFund( rem, fund ) {
		def qry = em.sqlContext.createNamedQuery( "remittance:getNonSerialReceiptDetailsByFund" );
		if ( fund )
			qry.setParameter( "fundid", fund.objid );
		return qry.setParameter( "remittanceid", rem.objid ).resultList;
	}
	
}
