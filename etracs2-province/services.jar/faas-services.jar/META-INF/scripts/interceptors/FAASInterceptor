import com.rameses.annotations.*;

class FAASInterceptor 
{
	@Service("TDService")
	def tdService;
	
	@Service("LogService")
	def logService;
	
	@Service("TransmittalService")
	def transmittalService;
	
	@Service("TaxpayerService")
	def taxpayerService;
	
	@Service("RemoteFaasService")
	def remoteService;
	
	@Env
	def env;
	
	@After(pattern="FAASService.create") 
	public void interceptCreate( evt ) {
		logService.log("CREATE", "FAAS", evt.result.objid);
	}
	
	@After(pattern="FAASService.submit") 
	public void interceptSubmit( evt ) {
		logService.log("SUBMIT", "FAAS", evt.result.objid);
		transmittalService.updateItemStateToForApproval(evt.result.transmittalId, evt.result.objid);
	}
	
	@After(pattern="FAASService.approve") 
	public void interceptApprove( evt ) {
		def faas = evt.result;

		/*
		tdService.post( evt.result );
		logService.log("GENERATE", "TD", faas.objid);
		logService.log("APPROVE", "FAAS", faas.objid);
		*/
		
		transmittalService.updateItemStateToCurrent(faas.transmittalId, faas.objid);
		taxpayerService.postMunicipalTaxpayer( 
			[ objid      : faas.info.taxpayer.taxpayerId,
			  lgu        : faas.rp.info.muniDistrict,
			  taxpayerNo : null,
			  name       : faas.info.taxpayer.taxpayerName,
			  address    : faas.info.taxpayer.taxpayerAddress,
			]  
		);
		
		approveRemoteFaas( faas );
	}
	
	@After(pattern="FAASService.disapprove") 
	public void interceptDisapprove( evt ) {
		def faas = evt.result;
		logService.logA("DISAPPROVE", "FAAS", faas.objid, faas.remarks);
		transmittalService.disapproveTransmittalItem(faas.transmittalId, faas.objid, faas.state, faas.remarks);
		disapproveRemoteFaas( faas ) ;
	}
	
	private void approveRemoteFaas( faas ) {
		if( faas.transmittalId != "system" ) return; 
		println "FAASInterceptor: approveRemoteFaas";
		remoteService.approve( 
			faas.rp.muniDistrictIndex,
			(env.USERNAME == null ? 'SYSTEM' : env.USERNAME),
			faas.objid,
			faas.info.txnType,
			faas.tdNo,
			faas.rp.info.pin,
			faas.info.issueDate
		);		
		logService.log("APPROVEREMOTE", "FAAS", faas.objid);
	}
	
	private void disapproveRemoteFaas( faas ) {
		if( faas.transmittalId != "system" ) return; 
		println "FAASInterceptor: disapproveRemoteFaas";
		remoteService.disapprove( 
			faas.rp.info.muniDistrictIndex,
			(env.USERNAME == null ? 'SYSTEM' : env.USERNAME),
			faas.objid,
			faas.remarks,
			env.USERNAME,
			env.JOBTITLE
		);		
		logService.log("DISAPPROVEREMOTE", "FAAS", faas.objid);
	}
}