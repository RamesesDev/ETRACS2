import com.rameses.annotations.*;
import com.rameses.io.*;

class FAASAttachmentService {

	@PersistenceContext("etracs")
	def em;
	
	@Service('Var')
	def var;
	
	@ProxyMethod
	public def createFaasAttachment(@Param(schema="faasattachment:faasAttachment") attachment ) {
		em.create("faasattachment:faasAttachment", attachment);
		def list = em.indexer.getIndexFor("faasattachment:faasAttachment");
		em.indexer.fire( list, attachment );
		return attachment;
	}
	
	@ProxyMethod
	public void uploadAttachment( attachment, data ) {
		print "UPLOADING == " + attachment.objid; 
		def fis = new FileOutputStream( findFile(attachment.objid).absolutePath, true );
		fis.write( data );
		fis.close();
	}
	
	@ProxyMethod
	public def downloadAttachment( objid ) {
		def file = findFile( objid );
		if ( !file ) throw new Exception("File not found.");
		
		def ftis = new FileTransferInputStream( file );
		ftis.byteSize = 1024 * 32;
		def data = [
			bytes : ftis.readNext(),
			eof : ftis.fileTransferInfo.eof
		];
		ftis.fileTransferInfo.save();
		
		if (ftis.fileTransferInfo.eof)
			ftis.fileTransferInfo.delete();
			
		ftis.close();
		return data;
	}
	
	private def findFile( id ) {
		def fileDir = new File( var.getProperty( 'faas_attachments_temp_dir', '' ) );
		if ( !fileDir.exists() )
			fileDir.mkdirs();
		fileDir.eachFileMatch( id ) { f ->
			return f;
		}
		def file = new File(var.getProperty( 'faas_attachments_temp_dir', '' ) + id );
		file.createNewFile();
		return file;
	}
	
	@ProxyMethod
	public def getAttachments( refId ) {
		def params = [ refId : refId ];
		return em.sqlContext.createNamedQuery( "faasattachment:findAttachmentByRefId" ).setParameters( params ).resultList;
	}

}
