import com.rameses.annotations.*;
import com.rameses.common.*


class InboxService
{
	@PersistenceContext('main')
	def em
	
	def INBOX_SCHEMA = 'message:inbox'
	def OUTBOX_SCHEMA = 'message:outbox'
	
	@ProxyMethod 
	public def testRemote( msg ) {
		println msg 
		return status('ok', 'Successfully received.')
	}
	
	@ProxyMethod
	public def receive( msg ) {
		println 'Received message[' + msg.fromlguindex + ' - ' + msg.fromlguname + ']'
		def oldmsg = em.read( INBOX_SCHEMA, [objid:msg.objid] )
		if( oldmsg ) {
			//the msg is probably resent, just confirm it
			return status('ok', 'Resent Accepted.')
		}
		try {
			em.create( INBOX_SCHEMA, msg )
			return status('ok', 'Successfully received.')
		}
		catch( e ) {
			println 'Error -> ' + e.message 
			return status('error', e.message )
		}
	}
	
	def status( stat, msg ) {
		return [status:stat, msg:msg]
	}
	
	
}