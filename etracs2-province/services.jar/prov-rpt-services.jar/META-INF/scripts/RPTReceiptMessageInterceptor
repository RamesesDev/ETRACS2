import com.rameses.annotations.*
import com.rameses.eserver.*;
import com.rameses.common.*;

class RPTReceiptMessageInterceptor  
{
	@PersistenceContext('main')
	def em
    
	@Service('LogService')
    def logSvc
    
    @Service('RPTReceiptService') 
    def receiptSvc
	
	@After(pattern='MessageService.onreceive') 
	public void interceptOnReceive( evt ) {
        def msg = evt.result 
		if( msg.action == 'rptreceipt_post_remote_collection') postRemoteRPTCollection( msg ) 
		else if( msg.action == 'rptreceipt_void_remote_collection') postVoidRemoteRPTCollection( msg ) 
	}
    
	void postVoidRemoteRPTCollection( msg ) {
        try {
            def retval = receiptSvc.postVoidRemoteRPTCollection( msg )
			updateSuccess( msg  )
            logSvc.log('RPTRECEIPT-POST-VOID-REMOTE-COLLECTION', 'RPTReceipt', msg.objid )
        }
        catch( e ) {
			updateError( msg, e )
        }
    }
	
	void postRemoteRPTCollection( msg ) {
        try {
            def retval = receiptSvc.postRemoteRPTCollection( msg )
			updateSuccess( msg  )
            logSvc.log('RPTRECEIPT-POST-REMOTE-COLLECTION', 'RPTReceipt', msg.objid )
        }
        catch( e ) {
			updateError( msg, e )
        }
    }
	
	void updateError( msg, e ) {
		msg.status =[date:new Date(), iserror:true, errormsg:e.message]
		em.update( msg.schemaname, msg )
	}
    
    void updateSuccess( msg ) {
        msg.status = [date: new Date(), iserror:false, errormsg:'']
        em.update( msg.schemaname, msg ) 
    }
	
}


