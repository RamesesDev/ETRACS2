import com.rameses.annotations.*
import com.rameses.eserver.*;
import com.rameses.common.*;

class RPTBillingMessageInterceptor 
{
	@PersistenceContext('main')
	def em
    
	@Service('LogService')
    def logSvc
    
    @Service('RPTBillingService')
    def billingSvc 
	
	@After(pattern='MessageService.onreceive') 
	public void interceptOnReceive( evt ) {
        def msg = evt.result 
		println 'Processing message -> ' + msg.action 
        if( msg.action == 'rptbill_generate') generateRPTBill( msg ) 
		else if( msg.action == 'rptbill_post_generated') postGenerateRPTBill( msg ) 
	}
    
	void postGenerateRPTBill( msg ) {
        try {
            billingSvc.postRemoteGeneratedBill( msg )
            updateSuccess( msg)
            logSvc.log('RPTBILL-POST-GENERATED', 'RPTBill', msg.data.sessionid )
        }
        catch( e ) {
			updateError( msg, e )
        }
    }
	
    void generateRPTBill( msg ) {
        try {
            billingSvc.generateRemoteRequestedBill( msg )
            updateSuccess( msg  )
            logSvc.log('RPTBILL-REMOTE', 'RPTBill', msg.data.sessionid )
        }
        catch( e ) {
            updateError( msg, e )
        }
    }
	
	void updateError( msg, e ) {
		msg.status =[date:new Date(), iserror:true, errormsg:e.message]
		em.update( msg.schemaname, msg )
	}
    
    void updateSuccess( msg ) {
        msg.status = [date: new Date(), iserror:false, errormsg:'']
        em.update( msg.schemaname, msg ) 
    }
	
}


