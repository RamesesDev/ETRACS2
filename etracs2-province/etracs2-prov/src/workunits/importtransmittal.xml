<workunit>
    <invokers>
        <invoker type="home.action" permission="transmittal.import" caption="Import Transmittal" icon="images/transmittal.png" target="window"/>
        <invoker type="formActions" permission="transmittal.save" action="saveTransmittal" caption="Save Transmittal" mnemonic="s" visibleWhen="#{save == false}" icon="images/save24.png" />
    </invokers>
    
    <code>
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        import javax.swing.JFileChooser;
        import etracs2.prov.transmittal.*;
        
        public class ImportTransmittalController
        {
            @FormTitle
            def title = "Import Transmittal"; 
            
            @Binding
            def binding;
            
            @Service("TransmittalService")
            def svc;
            
            def fileName;
            def message;
            def transmittal;
            def importing = false;
            def save = true;
            
            public void importTransmittal() {
                if( !importing ){
                    def t = new TransmitTask( caller:this );
                    OsirisContext.clientContext.taskManager.addTask( t );
                    importing = true;
                }else{
                    MsgBox.alert("Already importing.");
                }
            }
            
            public void saveTransmittal() {
                save = false;
                if( MsgBox.confirm("Save transmittal?") ) {
                    svc.saveTransmittal( transmittal.objid );
                    save = true;
                }
            }
            
            def listHandler = [
                getRows    : { return 50; },
                getColumns : {
                    return [
                        new Column( name:"item.type", caption:"Kind", width:30),
                        new Column( name:"item.txnType", caption:"Txn", width:30),
                        new Column( name:"item.tdNo", caption:"TD No.", width:110),
                        new Column( name:"item.pin", caption:"PIN", width:150),
                        new Column( name:"item.taxpayerName", caption:"Taxpayer", width:500),
                    ]
                },
                fetchList  : { 
                    return transmittal.items;
                },
                
            ] as PageListModel;
        }
        
        class TransmitTask extends Task
        {
            def caller;
            def reader;
            def counter = 0;
            def chunk = [state:"TRANSMITTAL", eof:false, delete:""];
            
            public void start(){
                if( !reader ){
                    reader = new TransmittalReader( caller.fileName.absolutePath );
                    caller.message = "Importing files $chunk.state [${counter}]";
                    caller.binding.refresh();
                    ended = false;
                }
            }

            public boolean accept(){  return true; }
            public void execute() {
                try{
                    
                        chunk = reader.read(chunk);
                        ended = (ended = chunk.eof); 
                        chunk = caller.svc.importTransmittal( chunk );
                        caller.message = "Importing files $chunk.state [${counter}]";
                        counter ++;

                }catch(e){
                    cancelled = true;
                    caller.message = "ERROR: " + e.cause?.message
                    caller.importing = false;
                    ended = true;
                }finally{
                    caller.binding.refresh();
                }
                
                Thread.sleep(100);
            }
            
            public void end(){
                if( !cancelled ) {
                    caller.save = false;
                    caller.message = "Done exporting file.";
                    caller.transmittal = caller.svc.open( chunk.transmittalId );
                    caller.binding.fireNavigation("main");
                }
                caller.binding.refresh();
                try{ reader.close(); }catch(e){;}
            }
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page template="etracs2.prov.transmittal.ImportTransmittalInitPage" />
        <page name="main" template="etracs2.prov.transmittal.ImportTransmittalPage" />
    </pages>
</workunit>