<workunit>
    <invokers>
        <invoker type="formActions" tooltip="Close" mnemonic="c" action="_close" icon="images/remove24.png" />
        <invoker type="formActions" action="submit" permission="faas.submit" tooltip="Submit For Approval" mnemonic="s" visibleWhen="#{state == 'PROVAPPROVAL'}" icon="images/submit24.png" />
        <invoker type="formActions" action="approve" permission="faas.approve" tooltip="Approve"  mnemonic="a" visibleWhen="#{state == 'FORAPPROVAL'}" icon="images/approve24.png" />
        <invoker type="formActions" action="doDisapprove" permission="faas.disapprove" tooltip="Disapprove" mnemonic="d" visibleWhen="#{state == 'PROVAPPROVAL' || state == 'FORAPPROVAL'}" icon="images/disapprove24.png"/>
        <invoker type="formActions" action="doReturn" permission="faas.return" tooltip="Return to Reviewer" mnemonic="r" visibleWhen="#{state == 'FORAPPROVAL'}" icon="images/return24.png"/>
    </invokers>
    
    <code>
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        
        public class FAASController 
        {
            @Service("FAASService")
            def faasService;
            
            @Service("FAASHtmlService")
            def htmlService;
                    
            @Binding
            def binding;
            
            def faasId;
            def tdNo;
            def state;
            def attachment;
            def listRefreshHandler;
            def remarks;
            def title = "FAAS Information";
            
            public void submit() {
                if( MsgBox.confirm("Submit FAAS?") ) {
                    def faas = faasService.submit( faasId );
                    state = faas.state;
                    refreshList();
                }
            }
            
            public def approve() {
                if( MsgBox.confirm("Approve FAAS?") ) {
                    def faas = faasService.approve( faasId );
                    state = faas.state;
                    refreshList();
                    return "_close";
                }
            }
            
            public def doDisapprove() {
                return InvokerUtil.lookupOpener("message_popup", [
                    caption:"Please provide a reason for disapproval.",
                    acceptHandler:{ msg -> 
                        def faas = faasService.disapprove( faasId, msg );
                        state = faas.state;
                        binding.refresh("formActions");
                        refreshList();
                    }
                ]);
            }
            
            public def doReturn() {
                return InvokerUtil.lookupOpener("message_popup", [ 
                    caption:"Please provide reason for return.",
                    acceptHandler:{ msg ->
                        def faas = faasService.returnDoc( faasId, msg );
                        state = faas.state;
                        binding.refresh("formActions");
                        refreshList();
                    }
                ]);
            }
            
            public def getHtml() {
                return htmlService.getHtml( faasId );
            }
            
            public def showAttachment( params ) {
                def data = params.split("~~");
                print "FILE NAME >> " + data[2];
                def opener = InvokerUtil.lookupOpener("file:download", [fileName:data[2]] );
                opener.caption = "Attachment: " + data[1];
                return opener;
            }
            
            private void refreshList() {
                if( listRefreshHandler ) {
                    listRefreshHandler();
                }
            }
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page template="etracs2.prov.faas.FAASPage"/>
    </pages>
</workunit>