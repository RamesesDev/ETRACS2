<workunit>
    <invokers>
        <invoker type="formActions" caption="Close" mnemonic="c" action="_close" />
        <invoker type="formActions" caption="Submit For Approval" mnemonic="s" action="submit" visibleWhen="#{state == 'PROVAPPROVAL'}"  />
        <invoker type="formActions" caption="Approve" mnemonic="a" action="approve" visibleWhen="#{state == 'FORAPPROVAL'}"  />
        <invoker type="formActions" caption="Disapprove" mnemonic="d" action="doDisapprove" visibleWhen="#{state != 'DISAPPROVED'}"/>
        <invoker type="formActions" caption="Return to Reviewer" mnemonic="r" action="doReturn" visibleWhen="#{state == 'FORAPPROVAL'}" />
    </invokers>
    
    <code>
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        
        public class FAASController 
        {
            @Service("FAASService")
            def faasService;
            
            @Service("FAASHtmlService")
            def htmlService;
                    
            @Binding
            def binding;
            
            def faasId;
            def tdNo;
            def state;
            def attachment;
            def listRefreshHandler;
            def remarks;
            def title = "FAAS Information";
            
            public void submit() {
                if( MsgBox.confirm("Submit FAAS?") ) {
                    def faas = faasService.submit( faasId );
                    state = faas.state;
                    refreshList();
                }
            }
            
            public def approve() {
                if( MsgBox.confirm("Approve FAAS?") ) {
                    def faas = faasService.approve( faasId );
                    state = faas.state;
                    refreshList();
                    return "_close";
                }
            }
            
            public def doDisapprove() {
                return InvokerUtil.lookupOpener("message_popup", [
                    caption:"Please provide a reason for disapproval.",
                    acceptHandler:{ msg -> 
                        def faas = faasService.disapprove( faasId, msg );
                        state = faas.state;
                        binding.refresh("formActions");
                        refreshList();
                    }
                ]);
            }
            
            public def doReturn() {
                return InvokerUtil.lookupOpener("message_popup", [ 
                    caption:"Please provide reason for return.",
                    acceptHandler:{ msg ->
                        def faas = faasService.returnDoc( faasId, msg );
                        state = faas.state;
                        binding.refresh("formActions");
                        refreshList();
                    }
                ]);
            }
            
            public def getHtml() {
                return htmlService.getHtml( faasId );
            }
            
            def showAttachment( params ) {
                def data = params.split("~~");
                def opener = InvokerUtil.lookupOpener("file:download", [objid:data[0]] );
                opener.caption = "Attachment: " + data[1];
                return opener;
            }
            
            private void refreshList() {
                if( listRefreshHandler ) {
                    listRefreshHandler();
                }
            }
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page template="etracs2.prov.faas.FAASPage"/>
    </pages>
</workunit>