<workunit>
    <invokers>
        <invoker type="formActions" tooltip="Close" mnemonic="c" action="_close" icon="images/remove24.png" />
        <invoker type="itemActions" tooltip="Incomplete Requirements" mnemonic="e" action="doIncomplete" visibleWhen="#{selectedItem != null}" icon="images/cancel24.png"/>
        <invoker type="formActions" tooltip="Submit to Reviewer" mnemonic="s" action="submit" visibleWhen="#{state == 'RECEIVED'}"  icon="images/next24.png"/>
    </invokers>
    
    <code>
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        
        public class TransmittalController 
        {
            @Service("TransmittalService")
            def svc;
            
            def transmittal;
            def state;
            def listRefreshHandler;
            def selectedItem;
            def title = "Transmittal Information";
            def remarks;
            
            public def doIncomplete() {
                return InvokerUtil.lookupOpener("message_popup",[
                    caption:"Please provide a reason for return.",
                    acceptHandler:{ msg ->
                        def faas = svc.incompleteTransmittal( transmittal.objid, selectedItem.item.objid, msg );
                        refreshList();
                    }
                ]);
            }
            
            public void submit() {
                if( MsgBox.confirm("Submit to reviewer?") ) {
                    svc.submit( transmittal.objid );
                    state = "SUBMITTED";
                    refreshList();
                }
            }
            
            public def getHtml() {
                if( selectedItem?.item ) {
                    if( ! selectedItem.item.html ) {
                        System.out.println("getHtml");
                        selectedItem.item.html = svc.getItemHtml( selectedItem.item.objid );
                        System.out.println("done getHtml");
                    }
                    return selectedItem.item.html;
                }
                return null;
            }
            
            private void refreshList() {
                if( listRefreshHandler ) {
                    listRefreshHandler();
                }
            }
            
            def listHandler = [
                getRows    : { return 100; },
                getColumns : {
                    return [
                        new Column( name:"item.type", caption:"Kind", width:30),
                        new Column( name:"item.txnType", caption:"Txn", width:30),
                        new Column( name:"item.tdNo", caption:"TD No.", width:110),
                        new Column( name:"item.pin", caption:"PIN", width:150),
                    ]
                },
                fetchList  : { svc.getItemList( transmittal.objid ); },
            ] as PageListModel;
            
            public def showAttachment( params ) {
                def data = params.split("~~");
                def opener = InvokerUtil.lookupOpener("file:download", [fileName:data[2]] );
                opener.caption = "Attachment: " + data[1];
                return opener;
            }
            
            
        }
        
        ]]>
        
    </code>
    
    <pages>
        <page template="etracs2.prov.transmittal.TransmittalPage"/>
        <page name="incompletePage" template="etracs2.prov.IncompletePage"/>
    </pages>
</workunit>