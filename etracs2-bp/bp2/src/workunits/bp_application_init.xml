<workunit>
    <invokers>
        <invoker type="bp:new" action="init"             caption="Business Application" target="window"/>
        <invoker folderid="/menu/bp/txn" action="initNew" caption="New Business"/>
        <invoker folderid="/menu/bp/txn" action="initRenew" caption="Renew Business"/>
        <invoker folderid="/menu/bp/txn" action="initAddline" caption="Add Line Of Business"/>
        <invoker folderid="/menu/bp/txn" action="initRetire" caption="Retire Busines"/>
        <invoker folderid="/menu/bp/txn" action="initRetireline" caption="Retire Line of Business"/>
        <invoker folderid="/menu/bp/txn" action="initCaptureRenew" caption="Renew Business (CAPTURE)"/>
        <invoker folderid="/menu/bp/txn" action="initCaptureNew"   caption="New Busiess (Capture)"/>
        
        <invoker type="formActions" action="next" caption="Next" mnemonic="n" icon="images/addnew24.png"/>
    </invokers>
    <code>
<![CDATA[

import com.rameses.rcp.common.*;
import com.rameses.rcp.annotations.*;
import com.rameses.osiris2.client.*;

class BusinessApplication
{
    @Binding
    def binding;
    
    @Service('BPEnum')
    def enumSvc;
    
    @Service("BPApplicationService")
    def svc;
    
    def application = [
        docstate:'DRAFT',
        info:[taxpayername:'',taxpayeraddress:'', lobs:[]],
    ];
    
    def typeList;
    def modeList;

    void initCaptureNew(){
        init();
        application.txnmode = 'CAPTURE';
        application.txntype = 'NEW';   
    }
    
    void initCaptureRenew(){
        init();
        application.txnmode = 'CAPTURE';
        application.txntype = 'NEW';   
    }
    
    void initNew(){
        init();
        application.txnmode = 'ONLINE';
        application.txntype = 'NEW';
    }
    
    void initRenew(){
        init();
        application.txnmode = 'ONLINE';
        application.txntype = 'RENEW';
    }
    
    void init(){
        def res = enumSvc.getTypes(['applicationTypes','applicationModes']);
        typeList = res.applicationTypes;
        modeList = res.applicationModes;
    }
    
    def onselect = { entity ->
        if( entity ){
            application.businessid = entity.objid;
            application.info.taxpayername = entity.entityname;
            application.info.taxpayeraddress = entity.entityaddress;
            application.info.taxpayerid = entity.objid;
            application.taxpayerid = entity.objid;
        }
        binding.refresh();
    }
    
    def next(){
        def res = svc.evaluateTxnType( application );
        if( res.size() == 1 ) {
            application.businessid = res[0].objid;
            application.info.lobs = res[0].info.lobs;
            return InvokerUtil.lookupOpener('bp:open', [application:application]);
        }
        
        def lobs = null;
        InvokerUtil.invokeOpener( InvokerUtil.lookupOpener( 'bp:business_list', [list: res, onselect:{ lobs = it.lobs; }] ) );
        
        if( lobs != null ){
            application.info.lobs = lobs;
            return InvokerUtil.lookupOpener('bp:open', [application:application]);
        }

        return null;
    }
    
    public def lookupPayer(){
        return InvokerUtil.lookupOpener( 'entity:lookup', [onselect: onselect, searchText:application.info.taxpayername] );
    }
}

]]>        
        
    </code>
    <pages>
        <page template="etracs2.bp.application.ApplicationInitialPage"/>
    </pages>
</workunit>