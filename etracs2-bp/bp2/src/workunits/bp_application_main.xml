<workunit>
    <invokers>
        <invoker type="bp.DRAFT" action="initView" caption="BP Application" target="window"/>
        <invoker type="bp.create" action="init" caption="BP Application"/>
        <invoker type="bp.view" action="initView" caption="BP Application" target="window"/>
        <invoker type="bp.open" action="initView" caption="BP Application"/>

        <invoker type="formActions" action="cancel" caption="Cancel" mnemonic="c" icon="images/cancel24.png" immediate="true"/>
        <invoker type="formActions" action="edit"   caption="Edit"   mnemonic="s" icon="images/edit24.png"   immediate="true"  shortcut="ctrl S" visibleWhen="#{mode == 'view'}"/>
        <invoker type="formActions" action="save"   caption="Save"   mnemonic="s" icon="images/save24.png"   shortcut="ctrl S"  visibleWhen="#{mode != 'view'}"/>
        <invoker type="formActions" action="delete" caption="Delete" mnemonic="d" icon="images/delete24.png"   immediate="true" shortcut="ctrl X" visibleWhen="#{application.txnno != null and application.docstate != 'APPROVED' }"/>
        
        <invoker type="formActions" action="submit"   caption="Submit" 
                 visibleWhen="#{application.docstate == 'DRAFT' and mode == 'view'}" icon="images/submit24.png"/>
    </invokers>
    <code>
<![CDATA[

import com.rameses.rcp.common.*;
import com.rameses.rcp.annotations.*;
import com.rameses.osiris2.client.*;

class BPApplication
{
    @Binding
    def binding;

    @Service('BPEnum')
    def enumSvc;
    
    @Service('BPApplicationService')
    def svc;

    def mode = 'view';
    def application;
    def organizations;
    def barangays;
    def officetypes;
    
    void init(){
        def res = enumSvc.getTypes(['organizations', 'officeTypes']);
        organizations = res.organizations;
        officetypes = res.officeTypes;
        barangays = enumSvc.barangays;
        mode = 'new';
    }
    
    void initView(){
        def res = enumSvc.getTypes(['organizations', 'officeTypes']);
        organizations = res.organizations;
        officetypes = res.officeTypes;
        barangays = enumSvc.barangays;
        mode = 'view';
    }
    
    def lob;
    
    def allowedDelete( def lob ){
        if( mode != 'VIEW' ){
            if( lob.assessmenttype.matches('NEW|ADDLOB') ) return true;
            if( lob.assessmenttype == 'RENEW' && application.txnmode == 'CAPTURE' ) return true;
            if( application.txntype == 'RETIRE_LINE' ) return true;
        }
        return false;
    }
    
    def getTypes = {
        if( application.txntype.matches('RETIRE|RETIRE_LINE')) return ['ACTIVE','RETIRE_LINE'];
        if( lob?.assessmenttype == 'RENEW' ) return ['RETIRE_LINE','RENEW'];
    }
    
    def isTypeEditable = {
        if( mode == 'VIEW' ) return false;
        if( application.txntype.matches('NEW|ADDLOB') ) return false;
        if( application.txnmode == 'CAPTURE' ) return false;
        if( lob?.assessmenttype == 'ADDLOB' ) return false;
        return true;
    }
    
    def lobHandler = [
        getRows    : { return 5; },
        getColumns : {
            return [
                new Column(name:"name", caption:"Classification"),
                new Column(name:"assessmenttype", caption:"Assessment Type", type:'combo', items:getTypes(), editable: isTypeEditable(), required:true),
                new Column(name:"iyear", caption:"Year")
            ];
        },
        
        onColumnUpdate: { val, name ->
            if( val ) lob.put(name, name);
        },
        
        onRemoveItem : {
            if( allowedDelete( it ) ) {
                application.lobs.remove( it );
            }
        },
        
        fetchList : { return application.lobs; },
    ] as SubListModel;
    
    def onselect = { selected ->
        if(selected){
            def o = application.lobs.find{ it.lobid == selected.objid };
            if( o ) throw new Exception("LOB '$selected.name' is already in application list.");
            def l = [lobid:selected.objid, name:selected.name, assessmenttype:'NEW', classificationid:selected.classificationid];
            if( application.txntype == 'ADDLOB' ) l.assessmenttype = 'ADDLOB';
            if( application.txnmode == 'CAPTURE' && application.txntype == 'RENEW' ) l.assessmenttype = 'RENEW';
            application.lobs << l;
            lobSearch = '';
            binding.refresh();
        }
    }
    
    def lobSearch;

    public def getLookupLob(){
        return InvokerUtil.lookupOpener('lob.lookup', [onselect:onselect, searchText:lobSearch]);
    }
    
    def cancel() {
        if( mode != 'edit' ) return '_close';
        application.putAll( old );
        binding.refresh();
        mode = 'view';
        return null;
    }

    def old = [:];
    
    void edit(){
        old.putAll( application );
        mode = 'edit';
    }
    
    void save(){
        application = svc.save( application );
        mode = 'view';
        binding.refresh();
    }
    
    def submit(){
        if( MsgBox.confirm("Submit for assessment?") ){
            application = svc.submitForAssessment( application.objid );
            return InvokerUtil.lookupOpener('bp.assessment', [application: application]);
        }
        return "default";
    }
    
    def delete(){
        if( MsgBox.confirm("Delete ?") ){
            svc.delete( application.objid );
            return '_close';
        }
        return null;
    }
    
    def previewApplication(){
        return InvokerUtil.lookupOpener('bp.applicationreport', [applicationid:application.objid]);
    }
    
    
    def viewPermit(){
        return InvokerUtil.lookupOpener('bp.bppermitreport', [applicationid:selectedItem.objid]);
    }
}

]]>
    </code>
    <pages>
        <page template="etracs2.bp.application.ApplicationMainPage"/>
    </pages>
</workunit>