import com.rameses.annotations.*
import com.rameses.common.*
import java.rmi.server.UID

class BusinessMgmtService{
	
	@Service("BPBillingService")
	def billingSvc;
	
	@Service('DateService')
	def dateService;
	
	@PersistenceContext('main')
	def em;
	
	def SCHEMANAME = 'bpapplication:bpapplication';
	
	private def format( def date, def format ){
		def sdf = new java.text.SimpleDateFormat( format );
		if( date instanceof Date ) return sdf.format( date );
		return sdf.parse( date );
	}

	def getResultList( def list, def qryname, def docstate, def searchText, def param ){
		list.clear();
		def qry = em.sqlContext.createNamedQuery( qryname );
		if( searchText ) 
			qry.setParameter('search', searchText);
		
		qry.setParameter('docstate', docstate);
		qry.setFirstResult( param._start );
		qry.setMaxResults( param._limit );
		list.addAll( qry.resultList );
		return list;
	}
	
	@ProxyMethod
	public def getList( def searchText, def docstate, def param ){
		def list = [];
		if( docstate ){
			if( !searchText )  return getResultList(list, 'bpmgmt:getList', docstate, searchText, param);
			if( getResultList( list, 'bpmgmt:getListByPermitNo', docstate, searchText, param ) ) return list;
			if( getResultList( list, 'bpmgmt:getListByBusinessName', docstate, searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getListByTaxpayerName', docstate, searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getListByBusinessAddress', docstate, searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getListByTaxpayerAddress', docstate, searchText+'%', param ) ) return list;
		}else{
			if( !searchText )  return getResultList(list, 'bpmgmt:getRetiredList', 'ACTIVE', searchText, param);
			if( getResultList( list, 'bpmgmt:getRetiredListByPermitNo', 'ACTIVE', searchText, param ) ) return list;
			if( getResultList( list, 'bpmgmt:getRetiredListByBusinessName', 'ACTIVE', searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getRetiredListByTaxpayerName', 'ACTIVE', searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getRetiredListByBusinessAddress', 'ACTIVE', searchText+'%', param ) ) return list;
			if( getResultList( list, 'bpmgmt:getRetiredListByTaxpayerAddress', 'ACTIVE', searchText+'%', param ) ) return list;
		}
		return list;
	}
	
	@ProxyMethod
	public def releasePermit( def permit ){
		def bp = em.read( 'bppermit:bppermit', [objid: permit.objid] );
		if( !bp ) throw new Exception('Permit with objid '+ permit.objid +' is no longer exist.');
		
		def app = em.read('bpapplication:bpapplication', [objid: bp.applicationid]);
		if( !bp ) throw new Exception('Application with objid '+ bp.applicationid +' is no longer exist.');
		if( app.docstate != 'PERMIT_PENDING' ) throw new Exception("Only permit pending transaction can be released.");
		
		bp.plateno = permit.plateno;
		bp.txndate = dateService.serverDate;
		bp.docstate = 'ACTIVE';
		
		em.update('bppermit:bppermit', bp);
		
		app.docstate = 'ACTIVE';
		em.update('bpapplication:bpapplication', app);
		
		em.sqlContext.createNamedExecutor('bpapplication:updateApplicationListingDocstate')
		  .setParameter('objid', bp.applicationid) 
		  .setParameter('docstate', 'ACTIVE')
		  .execute();
		
		return bp;
	}
	
	@ProxyMethod
	public def openPermit( def applicationid ){
		def permit = em.sqlContext.createNamedQuery('bpmgmt:findPermitByApplicationId')
					   .setParameter('applicationid', applicationid)
					   .singleResult;
		if( !permit ) throw new Exception('Permit with an applicationid '+ applicationid +' is no longer exist.');
		permit.lobs = em.serializer.read( permit.lobs );
		permit.txndate = (permit.docstate == 'ACTIVE') ? permit.txndate : null;
		return permit;
	}
	
	private def getBilling( def applicationid ){
		def app = em.read('bpapplication:bpapplication', [objid: applicationid]);
		if( !app ) throw new Exception("Application with objid $entity.applicationid is no longer exist.");
		
		def bp = em.read('business:business', [objid: app.businessid]);
		if( !bp ) throw new Exception("Business with objid $app.businessid is no longer exist.");
	
		def bill = [
			ledgerid      : bp.objid,
			yearstarted   : bp.yearstarted,
			lastyearpaid  : bp.lastyearpaid,
			lastqtrpaid   : bp.lastqtrpaid,
			taxfees       : []
		];
		
		def getUnpaidReceivables = { 
			def list = app.receivables.findAll{ it.amount > it.amtpaid };
			if( app.txntype.matches('NEW|ADDLOB') ) return list;
			return list.findAll{ it.qtr <= entity.qtr || ( it.assessmentype.matches('NEW|ADDLOB')) }
		}
		
		def receivables = getUnpaidReceivables();
		receivables.each{  
			it.year = it.iyear;
			it.qtr = it.iqtr;
			bill.taxfees << it;
		}
		return billingSvc.buildBill( bill );
	}
	
	@ProxyMethod
	public def retireApplication( def applicationid ){
		def app = open( applicationid );
		if( !app.txntype.matches('RETIRE|RETIRELOB') ) throw new Exception('Unable to retire '+app.txntype+' transaction.');
		def billing = getBilling( app.objid );
		if( billing.taxfees ) throw new Exception("Unable to retire.\nApplication not yet fully paid.");
		app.docstate = 'ACTIVE';
		
		def bp = em.read('business:business', [objid: app.businessid]);
		def parentapp = open( app.parentid );
		
		if(app.txntype == 'RETIRE'){
			bp.applicationid = app.objid;
			bp.docstate = 'RETIRED';
			parentapp.docstate = 'RETIRED';
			em.update( 'business:business', bp );
			
			em.sqlContext.createNamedExecutor('bpapplication:updateApplicationListingDocstate')
			  .setParameter('objid', parentapp.objid) 
			  .setParameter('docstate', 'RETIRED')
			  .execute();
		}
		
		em.sqlContext.createNamedExecutor('bpapplication:updateApplicationListingDocstate')
			  .setParameter('objid', parentapp.objid) 
			  .setParameter('docstate', 'ACTIVE')
			  .execute();
		
		em.update( SCHEMANAME, parentapp );
		em.update( SCHEMANAME, app );
		
		return app;
	}
	
	@ProxyMethod
	public def openRetireApplication( def applicationid ){
		def app = open( applicationid );
		def permit = openPermit( app.parentid );
		app.permitno = permit.txnno;
		return app;
	}
	
	def open( def objid ){
		def application = em.read( SCHEMANAME, [objid: objid] );
		if( !application ) throw new Exception("Application document no longer exist.");
		return application;
	}
}