import com.rameses.annotations.*;

public class BPPermitReportService
{
	@PersistenceContext('main')
	def em;
	
	@Service('Var')
	def var;
	
	@ProxyMethod
	public def getPermitReportInfo( def applicationid ){
		def yearFormat = new java.text.SimpleDateFormat('yyyy');
		def dateFormat = new java.text.SimpleDateFormat('yyyy-MM-dd');
	
		def bp = em.sqlContext.createNamedQuery('bpmgmt:findPermitByApplicationId')
				   .setParameters([applicationid: applicationid])
		           .singleResult;
				   
		def app = em.read('bpapplication:bpapplication', [objid:applicationid]);

		bp.txntype = app.txntype;
		bp.barcode = app.barcode;
		bp.barcodeurl = var.get('barcode_url').replace('$P{data}', app.barcode);
		
		bp.lines = em.serializer.read( bp.lobs );
		bp.lobs = null;
		
		bp.iyear = yearFormat.format( bp.txndate );
		bp.validity = dateFormat.parse( bp.iyear + '-12-31' );
		
		def c = app.credits[0]
		def or = [orno: c.refno+'', 
				   ordate: dateFormat.parse( c.refdate ),
				   amount: 0.0];
		app.credits.findAll{ it.refno == or.orno }.each{ or.amount += it.amount + it.surcharge + it.interest - it.discount };
		bp.orlist = [ or ];
		
		def sdf = new java.text.SimpleDateFormat("EEEEE MMMMM dd, yyyy");
		def params = [
			PERMITDATE: sdf.format( bp.txndate ),
			LGUADDRESS: var.lgu_address,
			MAYORNAME: var.mayor_name,
			MAYORTITLE: var.mayor_title
		];
		
		return [reportName: 'bp/businesspermit',
			    info: bp,
				params: params];
	}
}