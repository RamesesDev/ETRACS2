import com.rameses.annotations.*;
import com.rameses.common.*;
import java.rmi.server.UID

class BPCollectionInterceptor {

	@Service("LogService")
	def logService;
	
	@Service("DateService")
	def dateService;
	
	@Service('BPLedgerService')
	def ledgerSvc;
	
	@Service("BPBillingService")
	def billingSvc;
	
	@PersistenceContext('main')
	def em;
		
	@Before(pattern="ReceiptService.create")
	public void beforeCreate( evt ){
		//println evt.args[0];
	}
	
	@After(pattern="ReceiptService.create") 
	public def summarizedItemsByAcctAfterCreate( evt ){
		def receipt = evt.result
		if( !'BUSINESS_TAX'.equals( receipt.doctype ) )
			return
			 
		receipt._items = receipt.items.clone()
		receipt.items = summarizedItems( receipt )
		
		return receipt
	}
	
	@After(pattern="ReceiptService.open")
	public def summarizedItemsByAcctAfterOpen( evt ){
		def receipt = evt.result
		if( !'BUSINESS_TAX'.equals( receipt.doctype ) )
			return
		
		receipt.items = summarizedItems( receipt )
		
		return receipt		
	}
	
	@After(pattern="ReceiptService.create") 
	public void afterCreate( evt ) {
		def receipt = evt.result;
		if( receipt?.doctype != 'BUSINESS_TAX' ) return;
			
		def app = em.read('bpapplication:bpapplication', [objid: receipt.applicationid]);
		
		if( app.lastmodified != receipt.applicationlastmodified ) 
			throw new Exception("Unabled to continue.\nThe document has been modified by the other user.");
		
		def payment = [
			 applicationid: app.objid,
			 refid: receipt.objid,
			 reftype: 'ONLINE',
			 refno: receipt.info.serialno,
			 refdate: receipt.info.txndate,
			 year: receipt.year,
			 qtr: receipt.qtr,
			 items: []
		];
		
		//change amount -> totalamount
		receipt._items.each{ r ->
			payment.items << [ bpreceivableid	: r.taxfeeid,
							 taxamount		: r.taxamount,
							 surcharge		: r.surcharge,
							 interest		: r.interest,
							 discount		: r.discount,
							 totalamount	: r.amount ];
		}
		
		ledgerSvc.postPayment( payment );
		updateAppFullypaid( receipt )
		
	}
	
	@After(pattern="ReceiptService.delete") 
	public void interceptDeleteBPReceipt( evt ) {
		def receipt = evt.result;
		if( receipt?.doctype != 'BUSINESS_TAX' ) return;
		
		def app = em.read('bpapplication:bpapplication', [objid: receipt.applicationid]);
		
		if( app.lastmodified != receipt.applicationlastmodified ) 
			throw new Exception("Unabled to continue.\nThe document has been modified by the other user.");
		
		def payment = [
			 applicationid: app.objid,
			 refid: receipt.objid,
			 reftype: 'ONLINE',
			 refno: receipt.info.serialno,
			 refdate: receipt.info.txndate,
			 items: []
		];
		
		receipt.items.each{ r ->
			payment.items << [ bpreceivableid	: r.taxfeeid,
							 amount			: r.amount,
							 surcharge		: r.surcharge,
							 interest		: r.interest,
							 discount		: r.discount ];
		}
		
		ledgerSvc.deletePayment( payment );
	}
	
	@After(pattern="ReceiptService.update") 
	public void interceptUpdateBPReceipt( evt ) {
		def receipt = evt.result;
		if( receipt?.doctype != 'BUSINESS_TAX' ) return;
		
		def app = em.read('bpapplication:bpapplication', [objid: receipt.applicationid]);
		
		if( app.lastmodified != receipt.applicationlastmodified ) 
			throw new Exception("Unabled to continue.\nThe document has been modified by the other user.");
		
		def payment = [
			 applicationid: app.objid,
			 refid: receipt.objid,
			 reftype: 'ONLINE',
			 refno: receipt.info.serialno,
			 refdate: receipt.info.txndate,
			 items: []
		];
		
		receipt.items.each{ r ->
			payment.items << [ bpreceivableid	: r.taxfeeid,
							 amount			: r.amount,
							 surcharge		: r.surcharge,
							 interest		: r.interest,
							 discount		: r.discount ];
		}
		
		ledgerSvc.updatePayment( payment );
	}
	
	@After(pattern="ReceiptService.voidReceipt") 
	public void interceptVoidBPReceipt( evt ) {
		def receipt = evt.result;
		if( receipt?.doctype != 'BUSINESS_TAX' ) return;
		
		def app = em.read('bpapplication:bpapplication', [objid: receipt.applicationid]);

		//if( app.lastmodified != receipt.applicationlastmodified ) 
		//	throw new Exception("Unabled to continue.\nThe document has been modified by the other user.");
		
		def payment = [
			 applicationid: app.objid,
			 refid: receipt.objid,
			 reftype: 'ONLINE',
			 refno: receipt.info.serialno,
			 refdate: receipt.info.txndate,
			 items: []
		];
		
		receipt.items.each{ r ->
			payment.items << [ bpreceivableid	: r.taxfeeid,
							 amount			: r.amount,
							 surcharge		: r.surcharge,
							 interest		: r.interest,
							 discount		: r.discount ];
		}
		
		ledgerSvc.deletePayment( payment );
		
	}
	
	public def updateAppFullypaid( receipt ){	
		def app = em.read('bpapplication:bpapplication', [objid: receipt.applicationid])
		if( !app ) throw new Exception("Application with objid $receipt.applicationid no longer exists.")
		
		def getUnpaidReceivables = app.receivables.findAll{ it.amount > it.amtpaid }
				
		if( !getUnpaidReceivables )
			em.sqlContext.createNamedExecutor( "business:updateAppFullypaid" ).setParameter( 'businessid', receipt.businessid ).execute()
	}
	
	private def summarizedItems( def receipt ){
		def bt_items = summarizedByBTItems( receipt )
		receipt.items.removeAll( receipt.items.findAll{ it.systype.equals('BUSINESS_TAX') } )
		receipt.items.addAll( bt_items )
		receipt.items = summarizedByAccts( receipt )
		
		return receipt.items
	}
	
	private def summarizedByBTItems( def receipt ){
		def bt_items = receipt.items.findAll{ it.systype.equals('BUSINESS_TAX') }
		def fqtr = { qtr ->
			if( qtr == 1 )
				return 'st'
			else if( qtr == 2)
				return 'nd'
			else if( qtr == 3 )
				return 'rd'
			else if( qtr == 4 )
				return 'th'
		} 
		
		bt_items = bt_items.clone().unique{ it.lobid }.each(){ item ->
			def amount = receipt.items.findAll{ it.lobid.equals(item.lobid) && it.systype.equals('BUSINESS_TAX') }.amount.sum()
			def nqtr = receipt.items.findAll{ it.lobid.equals(item.lobid) && it.systype.equals('BUSINESS_TAX') }.size()
						
			if( nqtr == 4 ) nqtr = 'Full paid'
			else if( nqtr == 1 ) nqtr = "$item.iqtr" + fqtr(item.iqtr) + " Qtr"
			else nqtr = "$item.iqtr-$receipt.qtr Qtr"
			
			item.accttitle = "$item.accttitle - $nqtr".toString()
			item.amount = ( amount ) ? amount : item.amount
		}   
		
		return bt_items
	}
	   
	private def summarizedByAccts( def receipt ){
		receipt.items = receipt.items.clone().unique{ it.acctid }.each(){ item ->
			def amount = receipt.items.findAll{ it.acctid.equals(item.acctid) }.amount.sum()
			item.amount = ( amount ) ? amount : item.amount
		}
		
		return receipt.items
	}
	
	
	
}
