import com.rameses.annotations.*;


public class DesktopLoginInterceptor
{
	@Env
	def env;
	
	@Service("JobPermissionService")
	def jobpermSvc;
	
	@After(pattern="LoginService.login.*", eval="env.CLIENTTYPE=='desktop'")
	public void loadProfile( evt )
	{
		def profile = evt.result;
		profile.permissions = [];
		
		def perms = jobpermSvc.getAllPermissions([userid: profile.userid]);
		if( perms ) {
			profile.permissions.addAll( perms );
		}
		
		profile.env = [
			userid              : profile.objid,
			USERID              : profile.objid,
			USERTYPE            : profile.usertype,
			LOGINID             : profile.uid, 
			CHANGE_PWD_ON_LOGIN : profile.changepwdonlogin,
			FIRSTNAME           : profile.firstname,
			LASTNAME            : profile.lastname,
			USERNAME            : profile.lastname + ', ' + profile.firstname + (profile.middlename? ' ' + profile.middlename : ''),
			USERFORMALNAME      : profile.firstname + (profile.middlename? ' ' + profile.middlename : '') + ' ' + profile.lastname,
		];
		
		//add system permission
		profile.permissions.add("system.*");
	}
	
}