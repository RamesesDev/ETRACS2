import com.rameses.annotations.*
import com.rameses.eserver.*;
import com.rameses.common.*;

class EntityMessageInterceptor
{
	@PersistenceContext('main')
	def em
    
	@Service('LogService')
    def logSvc
    
    @Service('EntityService')
    def entitySvc
	
	@After(pattern='MessageService.onreceive') 
	public void interceptOnReceive( evt ) {
        def msg = evt.result 
        if( msg.action == 'entity.create_entity_for_mapping') createEntityForMapping( msg ) 
		else if (msg.action == 'entity.process_mapping' ) createMapping( msg )
		else if (msg.action == 'entity.delete_mapping' ) deleteMapping( msg )
	}
    
	void deleteMapping( msg ) {
		try {
            println 'Processing message -> ' + msg.action 
            def retval = entitySvc.deleteEntityMapping( msg.data )
            updateMessageInfo( msg, retval )
            logSvc.log('ENTTIY-DELETE-MAPPING', 'EntityMapping', msg.data.parentid )
        }
        catch( e ) {
            println '-'*30 
            e.printStackTrace()
            msg.message =[date:new Date(), msg:e.message]
            throw e 
        }
	}
	
	void createMapping( msg ) {
		try {
            println 'Processing message -> ' + msg.action 
            def retval = entitySvc.createEntityMapping( msg.data )
            updateMessageInfo( msg, retval )
            logSvc.log('ENTTIY-PROCESS-MAPPING', 'EntityMapping', msg.data.entity.objid )
        }
        catch( e ) {
            println '-'*30 
            e.printStackTrace()
            msg.message =[date:new Date(), msg:e.message]
            throw e 
        }
	}
	
	
    void createEntityForMapping( msg ) {
        try {
            println 'Processing message -> ' + msg.action 
			def parententity = msg.data.parententity 
			entitySvc.createEntityForMapping( parententity )
            logSvc.log('CREATE-ENTITY-FOR-MAPPING', 'EntityMapping', parententity.objid )
        }
        catch( e ) {
            println '-'*30 
            e.printStackTrace()
            msg.message =[date:new Date(), msg:e.message]
            throw e 
        }
    }
	
	
	void updateMessageInfo( msg, retval  ) {
        msg.message = retval 
        em.update( msg.schemaname, msg ) 
    }
    
}


