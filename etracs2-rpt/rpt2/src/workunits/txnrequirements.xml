<?xml version="1.0" encoding="UTF-8"?>
<workunit>
        <invoker type="txnreq.create" action="createItem" caption="Create Transaction Requirement" mnemonic="c" icon="images/addnew24.png" target="popup"/>
        <invoker type="txnreq.open" action="openItem" caption="Edit Transaction Requirement" mnemonic="e" icon="images/addnew24.png" target="popup"/>
        
        <invoker type="formActions" action="_close" shortcut="ctrl C" immediate="true" caption="Close" mnemonic="c" icon="images/addnew24.png" />
        <invoker type="formActions" action="edit" shortcut="ctrl E" visibleWhen="#{mode == 'view' and entity.objid != null }" immediate="true" caption="Edit" mnemonic="e" icon="images/edit24.png" />
        <invoker type="formActions" action="save" shortcut="ctrl S" visibleWhen="#{mode != 'view'}" caption="Save" mnemonic="s" icon="images/save24.png"/>
    
    <code lang="groovy">
        <![CDATA[
        
        import com.rameses.rcp.common.*;
        import com.rameses.rcp.annotations.*;
        import com.rameses.osiris2.client.*;
        
        public class TransactionRequirementsController {
            
            @Binding
            def binding;
            
            @Service("TxnRequirementsService")
            def svc;
            
            def mode = "view" ;
            def entity;
            def txntype;
            def requirements;
            def txntypelist = [];
            
            /*---------------------------------------------------------------------
            * FormAction Support
            ---------------------------------------------------------------------*/
            def createItem() {
                mode = "create"; 
                entity = createEntity();
                txntypelist = svc.getTxnTypes().collect{ [objid:it.objid, txntype:it.txntype] };
                
                return "new";
            }

            void openItem() {
                mode = "view";
                entity = svc.open( entity.objid );
                
                txntypelist = svc.getAllTxnTypes().collect{ [objid:it.objid, txntype:it.txntype] };
            }
            
            /*---------------------------------------------------------------------
            * Main
            ---------------------------------------------------------------------*/
            
            def getTxnTypes(){
                return txntypelist;
            }
            
            def getTxntype(){
                return [objid:entity.txntypeid, txntype: entity.txntype];
            }
            
            void setTxntype( txntype ){
                entity.txntypeid = txntype.objid;
                entity.txntype = txntype.txntype;
            }
            
            def createEntity() {
                return [
                    requirements : [],
                ];
            }
            
            def lookupRequirements = InvokerUtil.lookupOpener("requirements:lookup",[:]);
            
            def requirementsHandler = [
                getRows    : { return 20; },
                getColumns : {
                    return [
                        new Column(name:"requirement", caption:"Code", minWidth:50, editable:true, type:"lookup", handler:lookupRequirements, expression: '#{reqcode}'),
                        new Column(name:"reqname", caption:"Name", minWidth:200, editable:false)
                    ];
                },
                fetchList : { 
                    return entity.requirements; 
                },
                createItem : { return [:]; },
                validate       : { li -> validateTxnType( li.item ) },
                onAddItem : { item ->
                    updateRequirements( item );
                    entity.requirements.add( item );
                },
                onColumnUpdate : { item, colName ->
                    if( colName == 'requirement' ) {
                        updateRequirements( item );
                    }
                },
                onRemoveItem : { item -> 
                    if( mode == "view" ) return false;
                    if( MsgBox.confirm("Remove selected item?") ) {
                        entity.requirements.remove( item );
                    }
                },
            ] as SubListModel;
            
            void updateRequirements( item ){
                item.objid = item.requirement.objid;
                item.reqcode = item.requirement.reqcode;
                item.reqname = item.requirement.reqname;
            }
            
            void validateTxnType( item ){
                required( 'Code', item.requirement );
                checkDuplicate( item );
            }
            
            void checkDuplicate( item ){
                def data = entity.requirements.find{ it.objid == item.objid };
                if( data ){ 
                    MsgBox.alert('Duplicate not allowed!');
                    throw new Exception('Duplicate not allowed!');
                }
            }
            
            void save() {
                if( mode == "create") entity = svc.create( entity );
                else entity = svc.update( entity );
                
                mode = "view";
                binding.refresh("entity.*");
            }
            
            void edit() {
                mode = "edit";
                focus( "entity.txntype" );
            }
            
            /*---------------------------------------------------------------------
            * Support Methods
            ---------------------------------------------------------------------*/
            
            void focus( name ) {
                binding.refresh("entity.*");
                binding.focus( name );
            }
            
            void required( caption, value ) {
                if( !value ){ 
                    MsgBox.alert( caption + ' is required.')
                    throw new Exception( caption + ' is required.')
                }
            }
        }
        
        
        ]]>
    </code>
    
    <pages>
        <page name="new" template="etracs2.rpt.master.transactionrequirements.TransactionRequirementsPage" />
    </pages>
</workunit>
