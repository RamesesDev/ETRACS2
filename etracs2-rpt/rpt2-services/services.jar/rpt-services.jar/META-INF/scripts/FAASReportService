import com.rameses.annotations.*
import com.rameses.eserver.*;
import com.rameses.common.*;

class FaasReportService
{
	@PersistenceContext('main')
	def em
	
	@Service('NumberService')
	def numberSvc
	
	@ProxyMethod
	public def getReportData( faasid ) {
		def faasdata = [:]
		def faas = em.read('faas', [objid:faasid])
		if( !faas ) throw new Exception('Cannot open FAAS with ID No. ' + faasid + '.')
		
		faasdata.putAll( faas.info )
    	faasdata.putAll( faas.rp )
    	faasdata.putAll( faas.rpu )
		faasdata.taxeffectivity = faas.info.effectivityqtr + "Q - " + faas.info.effectivityyear
		faasdata.taxability = ( faasdata.info.taxable ? "TAXABLE" : "EXEMPT" )
		
		if( faas.rpu.rputype == 'land' ) {
			faasdata.landappraisals = getLandDetails( faas.rpu )
			faasdata.planttreesappraisals = getPlantTreeDetails( faas.rpu )
			faasdata.landadjustments = getLandAdjustments( faas.rpu )
			faasdata.propertyassessments = getPropertyAssessements( faas.rpu )
		} else if( faas.rpu.rputype == 'mach' ) {
			getLandOwnerInfo( faasdata )
			faasdata.machdetails = getMachDetails( faas.rpu )
			faasdata.propertyappraisals = getPropertyAppraisals( faas.rpu )
			faasdata.propertyassessments = getMachPropertyAssessments( faas.rpu )
		} else if( faas.rpu.rputype == 'planttree' ) {
			faasdata.planttreesappraisals = getPlantTreeDetails( faas.rpu )
			faasdata.landadjustments = getPlantTreeLandAdjustments( faas.rpu )
			faasdata.propertyassessments = getPlantTreePropertyAssessements( faas.rpu )
		} else 
			throw new Exception( 'There is no FAAS report for this record yet.' )
			
		return faasdata
	}
	
	private def getLandDetails( rpu ) {
    	def data = []
		def landdetails = rpu.info.landdetails
		
		landdetails.each {
			def item = [
				classification	: rpu.classname,
				subclass		: it.subclassname,
				actualuse 		: it.actualusename,
				area			: ( it.areatype == 'HA' ? it.areaha : it.areasqm ),
				unitvalue		: it.unitvalue,
				basemarketvalue	: it.basemarketvalue,
				areatype		: it.areatype
			]
			
			data.add( item )
		}
		
		return data
    }
	
	private def getPlantTreeDetails( rpu ) {
    	def data = []
		def planttreedetails= []
		
    	if( rpu.info.planttrees ) 
			planttreedetails = rpu.info.planttrees
		else 
			planttreedetails = rpu.info.planttreedetails
			
		planttreedetails.each {
			def item = [
				planttreename 	: it.planttreename,
				nonbearing		: it.nonbearing,
				bearing			: it.bearing,
				unitvalue		: it.unitvalue,
				basemarketvalue	: it.basemarketvalue
			]
			
			data.add( item )
		}
		
		return data
    }
	
	private def getLandAdjustments( rpu ) {
		def data = []
		def adjpercentage
		def percentadj
		def item
		def landdetails = rpu.info.landdetails
		
		landdetails.each { itm ->
			itm.landadjustments?.each {
				adjpercentage = ''
				
				if(itm.basemarketvalue != 0.00) {
					percentadj = (it.adjustment / itm.basemarketvalue) * 100
					adjpercentage = numberSvc.format("#,##0", percentadj) + ' %'
				}
				
				item = [
					itemid			: itm.objid,
					actualuse		: itm.actualusename,
					basemarketvalue	: itm.basemarketvalue,
					adjtypename		: it.adjtypename,
					adjpercentage	: adjpercentage,
					adjustment		: it.adjustment,
					marketvalue		: itm.marketvalue
				]
				
				data.add( item )
			}
			
			itm.adjustments?.each {
				adjpercentage = ''
				
				if(itm.basemarketvalue != 0.00) {
					percentadj = (it.adjustment / itm.basemarketvalue) * 100
					adjpercentage = numberSvc.format("#,##0", percentadj) + ' %'
				}
				
				item = [
					itemid			: itm.objid,
					actualuse		: itm.actualusename,
					basemarketvalue	: itm.basemarketvalue,
					adjtypename		: it.adjtypename,
					adjpercentage	: adjpercentage,
					adjustment		: it.adjustment,
					marketvalue		: itm.marketvalue
				]
				
				data.add( item )
			}
		}
		
		if( rpu.info.planttotal.basemarketvalue != 0.0 )
			data = data + getPlantTreeLandAdjustments( rpu )
		
		def group = data.groupBy{ it.itemid }
		group.keySet().each{
			def list = group[it] 
			for( int i = 0; i<list.size() -1; i++ ) {
				list[i].marketvalue = null 
			}
		}
		
		return data
	}
	
	private def getPropertyAssessements( rpu ) {
		def data = []
		def assesslevel
		def item
		
		if( rpu.info.landdetails ) {
			assesslevel = numberSvc.format("#,##0", rpu.info.landdetails[0].assesslevel) + " %"
			item = [
				classification	: rpu.classname,
				actualuse 		: rpu.info.landdetails[0].actualusename,
				marketvalue		: rpu.info.landtotal.marketvalue,
				assesslevel		: assesslevel,
				assessedvalue	: rpu.info.landtotal.assessedvalue
			]
			
			data.add( item )
		}
		
		if( rpu.info.planttrees ) {
			assesslevel = numberSvc.format("#,##0", rpu.info.planttrees[0].assesslevel) + " %"
			item = [
				classification	: rpu.classname,
				actualuse 		: 'PLANT',
				marketvalue		: rpu.info.planttotal.marketvalue,
				assesslevel		: assesslevel,
				assessedvalue	: rpu.info.planttotal.assessedvalue
			]
		}
		
		return data
	}
	
	private void getLandOwnerInfo( faasdata ) {
		def info = em.sqlContext.createNamedQuery('faas:getLandOwnerInfo').setParameter('objid', faasdata.landfaasid).singleResult

		if(info) {
			faasdata.landownername = info.taxpayername
			faasdata.landownerpin = info.pin
		}
	}
	
	private def getMachDetails( rpu ) {
		def data = []
		def machuses = rpu.info.machuses
		
		machuses?.each { itm ->
			itm.machdetails?.each {
				def brandmodel = (it.brand? it.brand : '') + (it.model? '/' + it.model : '')
				
				def item = [
					machinename			: it.machinename,
					brandmodelno		: brandmodel,
					capacity			: it.capacity,
					yearacquired		: it.yearacquired,
					estimatedlife		: it.estimatedlife,
					remaininglife		: it.remaininglife,
					yearinstalled		: it.yearinstalled,
					operationyear		: it.operationyear
				]
				
				data.add( item )
			}
		}
		
		return data
	}
	
	private def getPropertyAppraisals( rpu ) {
		def data = []
		def machuses = rpu.info.machuses
		
		machuses?.each { itm ->
			itm.machdetails?.each {
				def additionalcost = new BigDecimal( 0.0 )
				
				if( it.freightcost )
					additionalcost.add( it.freightcost )
				
				if( it.insurancecost )
					additionalcost.add( it.insurancecost )
					
				if( it.installationcost )
					additionalcost.add( it.installationcost )
					
				if( it.othercost )
					additionalcost.add( it.othercost )
					
				def depreciation = numberSvc.format("#,##0", it.depreciation) + ' %'
				
				def item = [
					machinename			: it.machinename,
					originalcost		: it.originalcost,
					additionalcost		: additionalcost,
					acquisitioncost		: it.acquisitioncost,
					conversionfactor	: it.conversionfactor,
					replacementcost		: it.replacementcost,
					yearsused			: it.yearsused,
					marketvalue			: it.marketvalue,
					depreciation		: depreciation,
					depreciationvalue	: it.depreciationvalue
				]
				
				data.add( item )
			}
		}
		
		return data
	}
	
	private def getMachPropertyAssessments( rpu ) {
		def data = []
		def machuses = rpu.info.machuses
		
		machuses?.each {
			def assesslevel = numberSvc.format("#,##0", it.assesslevel) + ' %'
			def item = [
				actualuse		: it.actualusename,
				marketvalue		: it.marketvalue,
				assesslevel		: assesslevel,
				assessedvalue	: it.assessedvalue
			]
			
			data.add( item )
		}
		
		return data
	}
	
	private def getPlantTreeLandAdjustments( rpu ) {
		def data = []
		def adjpercentage
		def planttreedetails = []
		
		if( rpu.info.planttrees ) 
			planttreedetails = rpu.info.planttrees
		else 
			planttreedetails = rpu.info.planttreedetails
		
		if( planttreedetails ) {
			if( planttreedetails[0].adjustmentrate != 0.0 ) { 
				adjpercentage = numberSvc.format("#,##0", planttreedetails[0].adjustmentrate) + ' %'
				
				def item = [
					itemid			: 'PLANT',
					actualuse		: 'PLANT',
					basemarketvalue	: planttreedetails.basemarketvalue.sum(),
					adjtypename		: 'TOTAL LAND ADJUSTMENT',
					adjpercentage	: adjpercentage,
					adjustment		: planttreedetails.adjustment.sum(),
					marketvalue		: planttreedetails.marketvalue.sum()
				]
				
				data.add( item )
			}
		}
		
		return data
	}
	
	private def getPlantTreePropertyAssessements( rpu ) {
		def data = []
		
		def assesslevel = numberSvc.format("#,##0", rpu.info.planttreedetails[0].assesslevel) + ' %'
		
		def item = [
			classification	: rpu.classname,
			actualuse 		: 'PLANT',
			marketvalue		: rpu.totalmv,
			assesslevel		: assesslevel,
			assessedvalue	: rpu.totalav
		]
		
		data.add( item )
		
		return data
	}
}